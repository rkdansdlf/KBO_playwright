# KBO_Data v2 운영 절차서 (Runbook)

## 1) 목적·범위

* 본 문서는 KBO_Data 파이프라인을 **운영 관점**에서 안전·멱등·자동화로 돌리기 위한 표준 절차를 정의합니다.
* 프로젝트는 **정규시즌(경기 단위)** 과 **퓨처스리그(프로필 기반)** 을 분리한 **2-트랙 수집 구조**를 사용합니다. 정규시즌은 게임센터에서 수집한 원천 데이터를 밤에 시즌 누적으로 롤업하며, 퓨처스는 선수 프로필의 “퓨처스” 탭에서 시즌 누적만 동기화합니다.  

---

## 2) 시스템 구성 요약

* **수집→파싱→검증→저장** 4단계를 엄격히 따릅니다. 저장은 **UPSERT** 로 멱등성을 보장합니다. 
* 정규시즌 데이터 소스: 일정/게임센터(박스스코어·라인업·PBP). 퓨처스 소스: 선수 프로필(“퓨처스” 탭). 상세 URL·셀렉터는 URL 레퍼런스 문서를 기준으로 유지합니다.  

---

## 3) 정기 스케줄(운영 모드)

* **정규시즌 롤업(`crawl_games_regular`)**: 매일 **03:00 KST** 실행(경기 종료 후 수집+집계). 
* **퓨처스 동기화(`crawl_futures_profile`)**: 매주 **일요일 05:00 KST** 실행(변동성 낮음). 
* 컨테이너/볼륨 예시(로그·데이터 마운트) 참고: `scheduler` 서비스. 

> 운영 메모: 퓨처스는 실시간성이 낮아 **주 1회/일 1회 권장**이며, 사이트 관리 반영 지연을 감안해 스냅샷으로 취급합니다.  

---

## 4) 일일 운용 절차(정규시즌)

### A. 사전 체크(매일 02:50 KST)

1. 서버 건강 상태·디스크 용량·DB 커넥션 확인
2. **Rate Limit** 설정 확인(요청 간 **1–2초 간격**), 만일의 429 대비 **지수 백오프** 활성화. 실행 시간은 02:00~05:00 KST 권장. 
3. KBO 사이트 구조 변경 여부: URL 레퍼런스 경고 섹션 확인. 

### B. 수집 단계(스케줄러 자동)

1. **경기 목록 수집**: `Schedule.aspx`에서 `gameId` 추출. 
2. **게임센터 수집**

   * **박스스코어**: `section=REVIEW`(타자/투수 테이블). 
   * **라인업(XHR)**: `GetLineUpAnalysis` POST. 
   * **PBP**: `section=RELAY`(이닝별 이벤트). 
3. **로딩/오류 제어**: 핵심 셀렉터 대기·재시도·최대 재시도 횟수 설정. 

### C. 저장·집계 단계(자동)

1. 원천(게임 단위) → DB 저장
2. **야간 롤업**: 원천 기반으로 시즌 누적(AVG/ERA 등) 재계산 후 `SEASON_STATS`에 **UPSERT**. 

### D. 후검증(자동/수동 혼합)

* **멱등성**: 저장 로직은 UPSERT로 중복 방지. 재실행 시 최종 상태 유지. 
* **샘플 검증 쿼리**: 경기별/시즌별 조회 예시로 스팟 체크. 

---

## 5) 주간 운용 절차(퓨처스/비활성)

### A. 퓨처스(주 1회)

* 선수 프로필의 “퓨처스” 탭 누적 통계를 순회 수집(테이블 헤더명 기반 매핑 권장). 키 체계와 결측 처리 규칙을 준수합니다. 
* 결과에는 `league='FUTURES'`, `source='profile'` 식별자를 명시합니다. 

### B. 은퇴/비활성(월 1회 권장)

* **현역 집합**과 **역대 집합** 비교로 비활성 목록을 산출 → 상세 페이지 수집(정규시즌은 핵심 테이블 UPSERT, 기타 탭은 보조 테이블(JSON)). 
* 모듈/CLI 경로 및 실행 예시(전수 수집): `src/cli/crawl_retire.py --years 1982-2025 --concurrency 3`  

---

## 6) 수동 실행·재처리 플로우

* 스케줄러 실패·부분 누락 시, 동일 잡을 **재실행**해도 UPSERT로 멱등성 보장. (예: 네트워크·DOM 변동으로 일부 경기 누락) 
* 실패 건은 재시도 정책(지수 백오프)으로 큐에 재투입하거나, 문제 원인(셀렉터/URL 변경)을 수정 후 일괄 재처리합니다. 

---

## 7) 모니터링·로그·락(운영 안전장치)

* **로그/데이터 볼륨**: `./logs`, `./data` 마운트 구성 확인. 
* **집계 중 쓰기 충돌 방지**: 파일 락 또는 DB 트랜잭션 락 사용 권장. 

---

## 8) 장애 대응 플레이북

### A. 429/속도 초과

* 증상: 429·타임아웃 증가
* 대응: 요청 간격 **1–2초** 유지, **지수 백오프** 확대, 새벽 시간대로 분산. 

### B. 데이터 미집계(막경기 직후)

* 증상: 경기 종료 직후 PBP/분석 누락
* 대응: **최소 1시간 지연 후 재수집**, 다음 야간 롤업 때 재검증. 

### C. DOM/셀렉터 변경

* 증상: 핵심 셀렉터 미탐지
* 대응: URL 레퍼런스 경고 확인 후 셀렉터 업데이트·사전 검증 스크립트로 확인. 

---

## 9) 데이터 품질·무결성 점검

### A. 스키마·키·기본값

* 게임 단위 저장은 **UNIQUE 키+UPSERT**를 일관 적용하여 재실행 덮어쓰기 보장, 타자/투수 경기 지표는 **NULL 대신 0** 기본값 권장. 
* 시즌 롤업은 항상 **UPSERT**로 멱등성 유지. 

### B. 운영 점검 쿼리(예시)

* 시즌 TOP10 또는 리그 필터링으로 스팟 체킹. 

---

## 10) 변경 대응(셀렉터·URL)

* 박스스코어·PBP·라인업 엔드포인트/셀렉터 정의는 URL 레퍼런스 문서를 진실 소스로 유지합니다. 변경 시 문서 먼저 확인. 
* 배포 전 **구조 검증 스크립트**로 DOM 변화 여부를 체크하고, 실패 시 중단·수정 후 재시도합니다. 

---

## 11) 보안·에티켓

* **robots.txt 준수**, **1–2초 요청 간격**, **새벽 시간대 실행**, 식별 가능한 **User-Agent** 사용을 원칙으로 합니다. 

---

## 12) 운영 체크리스트

### 매일(정규시즌)

* [ ] 02:50 서버·디스크·DB 확인
* [ ] Rate Limit/백오프 ON, 새벽 시간대 OK 
* [ ] 03:00 수집·롤업 자동 실행 모니터링 
* [ ] 집계 완료 후 샘플 쿼리로 데이터 스팟 체크 

### 매주(일요일)

* [ ] 05:00 퓨처스 동기화 실행 확인(변동성 낮음)  

### 매월(권장)

* [ ] 은퇴/비활성 전수 점검·보강 수집(필요 시) 

---

## 13) 부록: 운영 커맨드 스니펫

* 스케줄러 컨테이너 예시 및 마운트 설정: `scheduler` 서비스 참조. 
* 은퇴/비활성 전수 수집(예시):
  `docker-compose run --rm kbo-crawler python src/cli/crawl_retire.py --years 1982-2025 --concurrency 3` 

---

필요하면 이 문서를 저장소의 `/docs/runbook.md`로 커밋할 형식으로 변환해 줄게요.
